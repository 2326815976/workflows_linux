name: Build Linux Tauri Template (AppImage)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libfuse2 \
            file \
            imagemagick

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked

      - name: Create project structure
        run: |
          mkdir -p tauri-build/dist
          mkdir -p tauri-build/src-tauri/src
          mkdir -p tauri-build/src-tauri/icons
          mkdir -p tauri-build/src-tauri/resources
          echo "<html><head></head><body></body></html>" > tauri-build/dist/index.html
          cd tauri-build && npm init -y

      - name: Create Cargo.toml
        run: |
          cat > tauri-build/src-tauri/Cargo.toml << 'EOF'
          [package]
          name = "tauri-shell"
          version = "1.0.0"
          edition = "2021"

          [build-dependencies]
          tauri-build = { version = "2", features = [] }

          [dependencies]
          tauri = { version = "2", features = [] }
          serde = { version = "1", features = ["derive"] }
          serde_json = "1"

          [profile.release]
          strip = true
          lto = true
          codegen-units = 1
          panic = "abort"
          opt-level = "z"
          EOF

      - name: Create build.rs
        run: |
          echo 'fn main() { tauri_build::build() }' > tauri-build/src-tauri/build.rs

      - name: Create tauri.conf.json
        run: |
          cat > tauri-build/src-tauri/tauri.conf.json << 'EOF'
          {
            "$schema": "https://schema.tauri.app/config/2",
            "productName": "tauri-shell",
            "version": "1.0.0",
            "identifier": "com.app.shell",
            "build": {
              "beforeBuildCommand": "",
              "beforeDevCommand": "",
              "devUrl": "http://localhost:3000",
              "frontendDist": "../dist"
            },
            "app": {
              "windows": [{"title": "App", "width": 1200, "height": 800, "resizable": true, "fullscreen": false}],
              "security": {"csp": null}
            },
            "bundle": {
              "active": true,
              "targets": ["appimage"],
              "icon": ["icons/icon.png"],
              "resources": ["resources/*"],
              "linux": {
                "appimage": {
                  "bundleMediaFramework": false
                }
              }
            }
          }
          EOF

      - name: Create main.rs
        run: |
          cat > tauri-build/src-tauri/src/main.rs << 'RUSTEOF'
          #![cfg_attr(not(debug_assertions), windows_subsystem = "windows")]
          use serde::Deserialize;
          use std::fs;
          use std::path::PathBuf;

          #[derive(Deserialize, Clone)]
          struct AppConfig {
              url: String,
              title: String,
          }

          fn main() {
              let config = load_config();
              tauri::Builder::default()
                  .setup(move |app| {
                      use tauri::Manager;
                      let window = app.get_webview_window("main").unwrap();
                      window.set_title(&config.title).ok();
                      window.eval(&format!("window.location.replace('{}')", config.url.replace("'", "\\'"))).ok();
                      Ok(())
                  })
                  .run(tauri::generate_context!())
                  .expect("error while running tauri application");
          }

          fn load_config() -> AppConfig {
              load_config_from_bundle().unwrap_or(AppConfig {
                  url: "https://example.com".to_string(),
                  title: "App".to_string(),
              })
          }

          fn load_config_from_bundle() -> Option<AppConfig> {
              let exe_path = std::env::current_exe().ok()?;

              // AppImage: é…ç½®æ–‡ä»¶åœ¨ $APPDIR/usr/share/tauri-shell/resources/
              if let Ok(appdir) = std::env::var("APPDIR") {
                  let appimage_path = PathBuf::from(&appdir)
                      .join("usr/share/tauri-shell/resources/app-config.json");
                  if let Ok(config_str) = fs::read_to_string(&appimage_path) {
                      return serde_json::from_str(&config_str).ok();
                  }
              }

              // å¤‡ç”¨ï¼šå¯æ‰§è¡Œæ–‡ä»¶åŒçº§ç›®å½•çš„ resources æ–‡ä»¶å¤¹
              let resources_path = exe_path.parent()?.join("resources").join("app-config.json");
              if let Ok(config_str) = fs::read_to_string(&resources_path) {
                  return serde_json::from_str(&config_str).ok();
              }

              // å¤‡ç”¨ï¼šå¯æ‰§è¡Œæ–‡ä»¶åŒçº§ç›®å½•
              let alt_path = exe_path.parent()?.join("app-config.json");
              let config_str = fs::read_to_string(&alt_path).ok()?;
              serde_json::from_str(&config_str).ok()
          }
          RUSTEOF

      - name: Create resources and icon
        run: |
          echo '{"url":"https://example.com","title":"App"}' > tauri-build/src-tauri/resources/app-config.json
          convert -size 512x512 xc:'#6495ED' PNG32:tauri-build/src-tauri/icons/icon.png
          cp tauri-build/src-tauri/icons/icon.png tauri-build/src-tauri/resources/icon.png

      - name: Build Linux AppImage
        run: |
          cd tauri-build
          cargo tauri build --bundles appimage

      - name: Prepare output package
        run: |
          # æŸ¥æ‰¾ç”Ÿæˆçš„ AppImage
          APPIMAGE_PATH=$(find tauri-build/src-tauri/target/release/bundle -name "*.AppImage" -type f | head -1)
          echo "Found AppImage: $APPIMAGE_PATH"

          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p output/tauri-shell

          # å¤åˆ¶ AppImage
          cp "$APPIMAGE_PATH" output/tauri-shell/tauri-shell.AppImage
          chmod +x output/tauri-shell/tauri-shell.AppImage

          # åˆ›å»º resources ç›®å½•å’Œé»˜è®¤é…ç½®
          mkdir -p output/tauri-shell/resources
          echo '{"url":"https://example.com","title":"App"}' > output/tauri-shell/resources/app-config.json
          cp tauri-build/src-tauri/icons/icon.png output/tauri-shell/resources/icon.png

          # åˆ›å»ºå®‰è£…è„šæœ¬
          cat > output/tauri-shell/install.sh << 'INSTALLEOF'
          #!/bin/bash
          set -e

          # è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          APP_NAME="{{APP_NAME}}"
          INSTALL_DIR="$HOME/.local/bin"
          DESKTOP_DIR="$HOME/.local/share/applications"
          ICON_DIR="$HOME/.local/share/icons"

          echo "ğŸš€ æ­£åœ¨å®‰è£… $APP_NAME..."

          # æ£€æµ‹åŒ…ç®¡ç†å™¨å¹¶å®‰è£…ä¾èµ–
          install_deps() {
              echo "ğŸ“¦ æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–..."
              if command -v apt-get &> /dev/null; then
                  if ! dpkg -l | grep -q libwebkit2gtk-4.1-0; then
                      echo "æ£€æµ‹åˆ° Debian/Ubuntuï¼Œå®‰è£… WebKit ä¾èµ–..."
                      sudo apt-get update && sudo apt-get install -y libwebkit2gtk-4.1-0
                  else
                      echo "âœ“ WebKit ä¾èµ–å·²å®‰è£…"
                  fi
              elif command -v dnf &> /dev/null; then
                  if ! rpm -q webkit2gtk4.1 &> /dev/null; then
                      echo "æ£€æµ‹åˆ° Fedoraï¼Œå®‰è£… WebKit ä¾èµ–..."
                      sudo dnf install -y webkit2gtk4.1
                  else
                      echo "âœ“ WebKit ä¾èµ–å·²å®‰è£…"
                  fi
              elif command -v pacman &> /dev/null; then
                  if ! pacman -Q webkit2gtk-4.1 &> /dev/null; then
                      echo "æ£€æµ‹åˆ° Arch Linuxï¼Œå®‰è£… WebKit ä¾èµ–..."
                      sudo pacman -S --noconfirm webkit2gtk-4.1
                  else
                      echo "âœ“ WebKit ä¾èµ–å·²å®‰è£…"
                  fi
              else
                  echo "âš ï¸ æœªçŸ¥ç³»ç»Ÿï¼Œå¦‚æœåº”ç”¨æ— æ³•å¯åŠ¨ï¼Œè¯·æ‰‹åŠ¨å®‰è£… webkit2gtk-4.1"
              fi
          }

          # å®‰è£…ä¾èµ–
          install_deps

          # åˆ›å»ºç›®å½•
          mkdir -p "$INSTALL_DIR" "$DESKTOP_DIR" "$ICON_DIR"

          # å¤åˆ¶åº”ç”¨
          echo "ğŸ“ å®‰è£…åº”ç”¨..."
          cp "$SCRIPT_DIR/tauri-shell.AppImage" "$INSTALL_DIR/${APP_NAME}.AppImage"
          chmod +x "$INSTALL_DIR/${APP_NAME}.AppImage"

          # å¤åˆ¶é…ç½®æ–‡ä»¶
          mkdir -p "$INSTALL_DIR/${APP_NAME}_resources"
          cp "$SCRIPT_DIR/resources/app-config.json" "$INSTALL_DIR/${APP_NAME}_resources/"
          cp "$SCRIPT_DIR/resources/icon.png" "$ICON_DIR/${APP_NAME}.png"

          # åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼
          cat > "$DESKTOP_DIR/${APP_NAME,,}.desktop" << EOF
          [Desktop Entry]
          Name=$APP_NAME
          Exec=$INSTALL_DIR/${APP_NAME}.AppImage
          Icon=$ICON_DIR/${APP_NAME}.png
          Type=Application
          Categories=Utility;
          EOF

          # æ›´æ–°æ¡Œé¢æ•°æ®åº“
          if command -v update-desktop-database &> /dev/null; then
              update-desktop-database "$DESKTOP_DIR" 2>/dev/null || true
          fi

          echo ""
          echo "âœ… å®‰è£…å®Œæˆï¼"
          echo "ğŸ“ åº”ç”¨ä½ç½®: $INSTALL_DIR/${APP_NAME}.AppImage"
          echo "ğŸ–¥ï¸ å¯ä»åº”ç”¨èœå•å¯åŠ¨ï¼Œæˆ–è¿è¡Œ: ${APP_NAME}.AppImage"
          echo ""

          # è¯¢é—®æ˜¯å¦ç«‹å³å¯åŠ¨
          read -p "æ˜¯å¦ç«‹å³å¯åŠ¨åº”ç”¨ï¼Ÿ[Y/n] " -n 1 -r
          echo
          if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
              "$INSTALL_DIR/${APP_NAME}.AppImage" &
          fi
          INSTALLEOF

          chmod +x output/tauri-shell/install.sh

          # æ‰“åŒ…ä¸º tar.gz
          cd output
          tar -czvf tauri-shell.tar.gz tauri-shell

          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          echo "=== è¾“å‡ºæ–‡ä»¶ ==="
          ls -lh tauri-shell.tar.gz
          ls -lh tauri-shell/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tauri-template
          path: output/tauri-shell.tar.gz
          retention-days: 30
