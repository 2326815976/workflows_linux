name: Build Linux Tauri Template (AppImage)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04  # 使用较旧的 Ubuntu 以获得更好的 glibc 兼容性

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libfuse2 \
            file

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked

      - name: Create project structure
        run: |
          mkdir -p tauri-build/dist
          mkdir -p tauri-build/src-tauri/src
          mkdir -p tauri-build/src-tauri/icons
          echo "<html><head></head><body></body></html>" > tauri-build/dist/index.html
          cd tauri-build && npm init -y

      - name: Create Cargo.toml
        run: |
          cat > tauri-build/src-tauri/Cargo.toml << 'EOF'
          [package]
          name = "tauri-shell"
          version = "1.0.0"
          edition = "2021"

          [build-dependencies]
          tauri-build = { version = "2", features = [] }

          [dependencies]
          tauri = { version = "2", features = [] }
          serde = { version = "1", features = ["derive"] }
          serde_json = "1"

          [profile.release]
          strip = true
          lto = true
          codegen-units = 1
          panic = "abort"
          EOF

      - name: Create build.rs
        run: |
          echo 'fn main() { tauri_build::build() }' > tauri-build/src-tauri/build.rs

      - name: Create tauri.conf.json
        run: |
          cat > tauri-build/src-tauri/tauri.conf.json << 'EOF'
          {
            "$schema": "https://schema.tauri.app/config/2",
            "productName": "tauri-shell",
            "version": "1.0.0",
            "identifier": "com.app.shell",
            "build": {
              "beforeBuildCommand": "",
              "beforeDevCommand": "",
              "devUrl": "http://localhost:3000",
              "frontendDist": "../dist"
            },
            "app": {
              "windows": [{"title": "App", "width": 1200, "height": 800, "resizable": true, "fullscreen": false}],
              "security": {"csp": null}
            },
            "bundle": {
              "active": true,
              "targets": ["appimage"],
              "icon": ["icons/icon.png"],
              "resources": ["resources/*"],
              "linux": {
                "appimage": {
                  "bundleMediaFramework": true,
                  "files": {}
                }
              }
            }
          }
          EOF

      - name: Create main.rs
        run: |
          cat > tauri-build/src-tauri/src/main.rs << 'RUSTEOF'
          #![cfg_attr(not(debug_assertions), windows_subsystem = "windows")]
          use serde::Deserialize;
          use std::fs;
          use std::path::PathBuf;

          #[derive(Deserialize, Clone)]
          struct AppConfig {
              url: String,
              title: String,
          }

          fn main() {
              let config = load_config();
              tauri::Builder::default()
                  .setup(move |app| {
                      use tauri::Manager;
                      let window = app.get_webview_window("main").unwrap();
                      window.set_title(&config.title).ok();
                      window.eval(&format!("window.location.replace('{}')", config.url.replace("'", "\\'"))).ok();
                      Ok(())
                  })
                  .run(tauri::generate_context!())
                  .expect("error while running tauri application");
          }

          fn load_config() -> AppConfig {
              load_config_from_bundle().unwrap_or(AppConfig {
                  url: "https://example.com".to_string(),
                  title: "App".to_string(),
              })
          }

          fn load_config_from_bundle() -> Option<AppConfig> {
              let exe_path = std::env::current_exe().ok()?;

              // AppImage: 配置文件在 $APPDIR/usr/share/tauri-shell/resources/
              if let Ok(appdir) = std::env::var("APPDIR") {
                  let appimage_path = PathBuf::from(&appdir)
                      .join("usr/share/tauri-shell/resources/app-config.json");
                  if let Ok(config_str) = fs::read_to_string(&appimage_path) {
                      return serde_json::from_str(&config_str).ok();
                  }
              }

              // 备用：可执行文件同级目录的 resources 文件夹
              let resources_path = exe_path.parent()?.join("resources").join("app-config.json");
              if let Ok(config_str) = fs::read_to_string(&resources_path) {
                  return serde_json::from_str(&config_str).ok();
              }

              // 备用：可执行文件同级目录
              let alt_path = exe_path.parent()?.join("app-config.json");
              let config_str = fs::read_to_string(&alt_path).ok()?;
              serde_json::from_str(&config_str).ok()
          }
          RUSTEOF

      - name: Create resources directory and config
        run: |
          mkdir -p tauri-build/src-tauri/resources
          echo '{"url":"https://example.com","title":"App"}' > tauri-build/src-tauri/resources/app-config.json

      - name: Create default icon
        run: |
          cd tauri-build/src-tauri/icons
          sudo apt-get install -y imagemagick
          convert -size 512x512 xc:'#6495ED' PNG32:icon.png
          # 复制到 resources 目录
          cp icon.png ../resources/icon.png
          ls -la

      - name: Build Linux AppImage
        run: |
          cd tauri-build
          cargo tauri build --bundles appimage
        env:
          NO_STRIP: true

      - name: Find and prepare AppImage
        run: |
          # 查找生成的 AppImage
          APPIMAGE_PATH=$(find tauri-build/src-tauri/target/release/bundle -name "*.AppImage" -type f | head -1)
          echo "Found AppImage: $APPIMAGE_PATH"

          # 复制到输出目录
          mkdir -p output
          cp "$APPIMAGE_PATH" output/tauri-shell.AppImage
          chmod +x output/tauri-shell.AppImage

          # 显示压缩前文件大小
          echo "=== 压缩前 ==="
          ls -lh output/tauri-shell.AppImage

      - name: Compress AppImage with UPX
        run: |
          # 安装 UPX
          sudo apt-get install -y upx-ucl

          # 使用 UPX 压缩 AppImage（--best 最高压缩率）
          echo "正在使用 UPX 压缩 AppImage..."
          upx --best --lzma output/tauri-shell.AppImage || echo "UPX 压缩跳过（可能不支持此格式）"

          # 显示压缩后文件大小
          echo "=== 压缩后 ==="
          ls -lh output/tauri-shell.AppImage
          file output/tauri-shell.AppImage

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tauri-template
          path: output/tauri-shell.AppImage
          retention-days: 30
