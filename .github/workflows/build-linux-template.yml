name: Build Linux Tauri Template

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libfuse2 \
            file \
            imagemagick

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri CLI
        run: cargo install tauri-cli --locked

      - name: Create project structure
        run: |
          mkdir -p tauri-build/dist
          mkdir -p tauri-build/src-tauri/src
          mkdir -p tauri-build/src-tauri/icons
          mkdir -p tauri-build/src-tauri/resources
          echo "<html><head></head><body></body></html>" > tauri-build/dist/index.html
          cd tauri-build && npm init -y

      - name: Create Cargo.toml
        run: |
          cat > tauri-build/src-tauri/Cargo.toml << 'EOF'
          [package]
          name = "tauri-shell"
          version = "1.0.0"
          edition = "2021"

          [build-dependencies]
          tauri-build = { version = "2", features = [] }

          [dependencies]
          tauri = { version = "2", features = [] }
          serde = { version = "1", features = ["derive"] }
          serde_json = "1"

          [profile.release]
          strip = true
          lto = true
          codegen-units = 1
          panic = "abort"
          opt-level = "z"
          EOF

      - name: Create build.rs
        run: |
          echo 'fn main() { tauri_build::build() }' > tauri-build/src-tauri/build.rs

      - name: Create tauri.conf.json
        run: |
          cat > tauri-build/src-tauri/tauri.conf.json << 'EOF'
          {
            "$schema": "https://schema.tauri.app/config/2",
            "productName": "tauri-shell",
            "version": "1.0.0",
            "identifier": "com.app.shell",
            "build": {
              "beforeBuildCommand": "",
              "beforeDevCommand": "",
              "devUrl": "http://localhost:3000",
              "frontendDist": "../dist"
            },
            "app": {
              "windows": [{
                "title": "App",
                "width": 1200,
                "height": 800,
                "resizable": true,
                "fullscreen": false,
                "transparent": false
              }],
              "security": {"csp": null}
            },
            "bundle": {
              "active": true,
              "targets": [],
              "icon": ["icons/icon.png"],
              "resources": ["resources/*"]
            }
          }
          EOF

      - name: Create main.rs
        run: |
          cat > tauri-build/src-tauri/src/main.rs << 'RUSTEOF'
          #![cfg_attr(not(debug_assertions), windows_subsystem = "windows")]
          use serde::Deserialize;
          use std::fs;
          use std::path::PathBuf;

          #[derive(Deserialize, Clone)]
          struct AppConfig {
              url: String,
              title: String,
          }

          fn main() {
              let config = load_config();
              tauri::Builder::default()
                  .setup(move |app| {
                      use tauri::Manager;
                      let window = app.get_webview_window("main").unwrap();
                      window.set_title(&config.title).ok();
                      window.eval(&format!("window.location.replace('{}')", config.url.replace("'", "\\'"))).ok();
                      Ok(())
                  })
                  .run(tauri::generate_context!())
                  .expect("error while running tauri application");
          }

          fn load_config() -> AppConfig {
              load_config_from_bundle().unwrap_or(AppConfig {
                  url: "https://example.com".to_string(),
                  title: "App".to_string(),
              })
          }

          fn load_config_from_bundle() -> Option<AppConfig> {
              let exe_path = std::env::current_exe().ok()?;
              // è§£æç¬¦å·é“¾æ¥ï¼Œè·å–çœŸå®è·¯å¾„
              let exe_path = exe_path.canonicalize().unwrap_or(exe_path);
              let exe_dir = exe_path.parent()?;

              // å°è¯•å¤šä¸ªå¯èƒ½çš„é…ç½®æ–‡ä»¶ä½ç½®
              let possible_paths = [
                  exe_dir.join("resources").join("app-config.json"),
                  exe_dir.join("app-config.json"),
                  // AppImage è·¯å¾„
                  std::env::var("APPDIR").ok().map(|appdir| {
                      PathBuf::from(appdir).join("usr/share/tauri-shell/resources/app-config.json")
                  }).unwrap_or_default(),
              ];

              for path in possible_paths.iter() {
                  if path.as_os_str().is_empty() {
                      continue;
                  }
                  if let Ok(config_str) = fs::read_to_string(path) {
                      if let Ok(config) = serde_json::from_str(&config_str) {
                          return Some(config);
                      }
                  }
              }

              None
          }
          RUSTEOF

      - name: Create resources and icon
        run: |
          echo '{"url":"https://example.com","title":"App"}' > tauri-build/src-tauri/resources/app-config.json
          convert -size 512x512 xc:'#6495ED' PNG32:tauri-build/src-tauri/icons/icon.png
          cp tauri-build/src-tauri/icons/icon.png tauri-build/src-tauri/resources/icon.png

      - name: Build Linux binary
        run: |
          cd tauri-build
          cargo tauri build

      - name: Prepare output package
        run: |
          # æŸ¥æ‰¾ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶
          BINARY_PATH="tauri-build/src-tauri/target/release/tauri-shell"
          echo "Found binary: $BINARY_PATH"
          ls -lh "$BINARY_PATH"

          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p output/tauri-shell

          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          cp "$BINARY_PATH" output/tauri-shell/tauri-shell
          chmod +x output/tauri-shell/tauri-shell

          # åˆ›å»º resources ç›®å½•å’Œé»˜è®¤é…ç½®
          mkdir -p output/tauri-shell/resources
          echo '{"url":"https://example.com","title":"App"}' > output/tauri-shell/resources/app-config.json
          cp tauri-build/src-tauri/icons/icon.png output/tauri-shell/resources/icon.png

          # åˆ›å»º README.md
          cat > output/tauri-shell/README.md << 'READMEEOF'
          # Linux App å®‰è£…æŒ‡å—

          ## å¿«é€Ÿå®‰è£…

          ```bash
          chmod +x install.sh && ./install.sh
          ```

          å®‰è£…è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
          - æ£€æµ‹å¹¶å®‰è£… WebKit ä¾èµ–
          - å¤åˆ¶ç¨‹åºåˆ° `~/.local/share/åº”ç”¨å/`
          - åˆ›å»ºåº”ç”¨èœå•å¿«æ·æ–¹å¼
          - åˆ›å»ºæ¡Œé¢å›¾æ ‡
          - è¯¢é—®æ˜¯å¦ç«‹å³å¯åŠ¨

          ## å¸è½½

          ```bash
          ~/.local/share/åº”ç”¨å/uninstall.sh
          ```

          ## æ‰‹åŠ¨è¿è¡Œï¼ˆä¸å®‰è£…ï¼‰

          ```bash
          # 1. å®‰è£…ä¾èµ–
          # Ubuntu/Debian:
          sudo apt-get install libwebkit2gtk-4.1-0

          # Fedora:
          sudo dnf install webkit2gtk4.1

          # Arch Linux:
          sudo pacman -S webkit2gtk-4.1

          # 2. è¿è¡Œï¼ˆè®¾ç½®ç¯å¢ƒå˜é‡è§£å†³æ¸²æŸ“é—®é¢˜ï¼‰
          chmod +x tauri-shell
          WEBKIT_DISABLE_COMPOSITING_MODE=1 ./tauri-shell
          ```

          ## å¸¸è§é—®é¢˜

          ### Permission denied
          ```bash
          chmod +x install.sh tauri-shell
          ```

          ### æ‰¾ä¸åˆ° WebKit åº“
          è¿è¡Œ `install.sh` ä¼šè‡ªåŠ¨å®‰è£…ï¼Œæˆ–æ‰‹åŠ¨å®‰è£…ä¸Šè¿°ä¾èµ–ã€‚

          ### æ¡Œé¢å›¾æ ‡æ— æ³•å¯åŠ¨
          å³é”®å›¾æ ‡ â†’ å±æ€§ â†’ æƒé™ â†’ å…è®¸æ‰§è¡Œ

          ### é¡µé¢æ˜¾ç¤ºé»‘è‰²é®æŒ¡
          è¿™æ˜¯ WebKit æ¸²æŸ“é—®é¢˜ï¼Œå®‰è£…è„šæœ¬å·²è‡ªåŠ¨é…ç½®ç¯å¢ƒå˜é‡è§£å†³ã€‚
          å¦‚æœæ‰‹åŠ¨è¿è¡Œï¼Œè¯·ä½¿ç”¨ï¼š
          ```bash
          WEBKIT_DISABLE_COMPOSITING_MODE=1 ./tauri-shell
          ```
          READMEEOF

          # åˆ›å»ºå®‰è£…è„šæœ¬
          cat > output/tauri-shell/install.sh << 'INSTALLEOF'
          #!/bin/bash
          set -e

          # è·å–è„šæœ¬æ‰€åœ¨ç›®å½•
          SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          APP_NAME="{{APP_NAME}}"
          APP_DIR="$HOME/.local/share/${APP_NAME}"
          BIN_DIR="$HOME/.local/bin"
          DESKTOP_DIR="$HOME/.local/share/applications"
          ICON_DIR="$HOME/.local/share/icons"

          echo "ğŸš€ æ­£åœ¨å®‰è£… $APP_NAME..."

          # æ£€æµ‹åŒ…ç®¡ç†å™¨å¹¶å®‰è£…ä¾èµ–
          install_deps() {
              echo "ğŸ“¦ æ£€æŸ¥å¹¶å®‰è£…ä¾èµ–..."
              if command -v apt-get &> /dev/null; then
                  if ! dpkg -l | grep -q libwebkit2gtk-4.1-0; then
                      echo "æ£€æµ‹åˆ° Debian/Ubuntuï¼Œå®‰è£… WebKit ä¾èµ–..."
                      sudo apt-get update && sudo apt-get install -y libwebkit2gtk-4.1-0
                  else
                      echo "âœ“ WebKit ä¾èµ–å·²å®‰è£…"
                  fi
              elif command -v dnf &> /dev/null; then
                  if ! rpm -q webkit2gtk4.1 &> /dev/null; then
                      echo "æ£€æµ‹åˆ° Fedoraï¼Œå®‰è£… WebKit ä¾èµ–..."
                      sudo dnf install -y webkit2gtk4.1
                  else
                      echo "âœ“ WebKit ä¾èµ–å·²å®‰è£…"
                  fi
              elif command -v pacman &> /dev/null; then
                  if ! pacman -Q webkit2gtk-4.1 &> /dev/null; then
                      echo "æ£€æµ‹åˆ° Arch Linuxï¼Œå®‰è£… WebKit ä¾èµ–..."
                      sudo pacman -S --noconfirm webkit2gtk-4.1
                  else
                      echo "âœ“ WebKit ä¾èµ–å·²å®‰è£…"
                  fi
              else
                  echo "âš ï¸ æœªçŸ¥ç³»ç»Ÿï¼Œå¦‚æœåº”ç”¨æ— æ³•å¯åŠ¨ï¼Œè¯·æ‰‹åŠ¨å®‰è£… webkit2gtk-4.1"
              fi
          }

          # å®‰è£…ä¾èµ–
          install_deps

          # åˆ›å»ºç›®å½•
          mkdir -p "$APP_DIR/resources" "$BIN_DIR" "$DESKTOP_DIR" "$ICON_DIR"

          # å¤åˆ¶åº”ç”¨åˆ°ç‹¬ç«‹ç›®å½•ï¼ˆä¿æŒ resources ç›¸å¯¹è·¯å¾„ï¼‰
          echo "ğŸ“ å®‰è£…åº”ç”¨..."
          cp "$SCRIPT_DIR/tauri-shell" "$APP_DIR/${APP_NAME}"
          chmod +x "$APP_DIR/${APP_NAME}"
          cp "$SCRIPT_DIR/resources/app-config.json" "$APP_DIR/resources/"
          cp "$SCRIPT_DIR/resources/icon.png" "$APP_DIR/resources/"

          # åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼ˆè®¾ç½®ç¯å¢ƒå˜é‡è§£å†³ WebKit æ¸²æŸ“é—®é¢˜ï¼‰
          cat > "$APP_DIR/start.sh" << STARTEOF
          #!/bin/bash
          export WEBKIT_DISABLE_COMPOSITING_MODE=1
          exec "\$(dirname "\$0")/${APP_NAME}" "\$@"
          STARTEOF
          chmod +x "$APP_DIR/start.sh"

          # åˆ›å»ºç¬¦å·é“¾æ¥åˆ° PATHï¼ˆæŒ‡å‘å¯åŠ¨è„šæœ¬ï¼‰
          ln -sf "$APP_DIR/start.sh" "$BIN_DIR/${APP_NAME}"

          # å¤åˆ¶å›¾æ ‡
          cp "$SCRIPT_DIR/resources/icon.png" "$ICON_DIR/${APP_NAME}.png"

          # åˆ›å»ºæ¡Œé¢å¿«æ·æ–¹å¼ï¼ˆåº”ç”¨èœå•ï¼‰
          cat > "$DESKTOP_DIR/${APP_NAME,,}.desktop" << EOF
          [Desktop Entry]
          Name=$APP_NAME
          Exec=env WEBKIT_DISABLE_COMPOSITING_MODE=1 $APP_DIR/${APP_NAME}
          Icon=$ICON_DIR/${APP_NAME}.png
          Type=Application
          Categories=Utility;
          EOF

          # åˆ›å»ºæ¡Œé¢å›¾æ ‡ï¼ˆå¦‚æœæ¡Œé¢ç›®å½•å­˜åœ¨ï¼‰
          USER_DESKTOP="$HOME/Desktop"
          [ ! -d "$USER_DESKTOP" ] && USER_DESKTOP="$HOME/æ¡Œé¢"
          if [ -d "$USER_DESKTOP" ]; then
              cp "$DESKTOP_DIR/${APP_NAME,,}.desktop" "$USER_DESKTOP/"
              chmod +x "$USER_DESKTOP/${APP_NAME,,}.desktop"
              gio set "$USER_DESKTOP/${APP_NAME,,}.desktop" metadata::trusted true 2>/dev/null || true
              echo "ğŸ–¥ï¸ å·²åˆ›å»ºæ¡Œé¢å›¾æ ‡"
          fi

          # æ›´æ–°æ¡Œé¢æ•°æ®åº“
          if command -v update-desktop-database &> /dev/null; then
              update-desktop-database "$DESKTOP_DIR" 2>/dev/null || true
          fi

          echo ""
          echo "âœ… å®‰è£…å®Œæˆï¼"
          echo "ğŸ“ åº”ç”¨ç›®å½•: $APP_DIR"
          echo "ğŸ–¥ï¸ å¯ä»åº”ç”¨èœå•å¯åŠ¨ï¼Œæˆ–è¿è¡Œ: ${APP_NAME}"
          echo "ğŸ—‘ï¸ å¸è½½è¯·è¿è¡Œ: $APP_DIR/uninstall.sh"
          echo ""

          # åˆ›å»ºå¸è½½è„šæœ¬
          cat > "$APP_DIR/uninstall.sh" << UNINSTALLEOF
          #!/bin/bash
          APP_NAME="${APP_NAME}"
          APP_DIR="$APP_DIR"
          BIN_DIR="$BIN_DIR"
          DESKTOP_DIR="$DESKTOP_DIR"
          ICON_DIR="$ICON_DIR"

          echo "ğŸ—‘ï¸ æ­£åœ¨å¸è½½ \$APP_NAME..."

          # åˆ é™¤ç¬¦å·é“¾ï¿½ï¿½
          rm -f "\$BIN_DIR/\$APP_NAME"

          # åˆ é™¤æ¡Œé¢å¿«æ·æ–¹å¼
          rm -f "\$DESKTOP_DIR/\${APP_NAME,,}.desktop"

          # åˆ é™¤æ¡Œé¢å›¾æ ‡
          USER_DESKTOP="\$HOME/Desktop"
          [ ! -d "\$USER_DESKTOP" ] && USER_DESKTOP="\$HOME/æ¡Œé¢"
          rm -f "\$USER_DESKTOP/\${APP_NAME,,}.desktop" 2>/dev/null

          # åˆ é™¤å›¾æ ‡
          rm -f "\$ICON_DIR/\$APP_NAME.png"

          # åˆ é™¤åº”ç”¨ç›®å½•
          rm -rf "\$APP_DIR"

          # æ›´æ–°æ¡Œé¢æ•°æ®åº“
          if command -v update-desktop-database &> /dev/null; then
              update-desktop-database "\$DESKTOP_DIR" 2>/dev/null || true
          fi

          echo "âœ… å¸è½½å®Œæˆï¼"
          UNINSTALLEOF
          chmod +x "$APP_DIR/uninstall.sh"

          # è¯¢é—®æ˜¯å¦ç«‹å³å¯åŠ¨
          read -p "æ˜¯å¦ç«‹å³å¯åŠ¨åº”ç”¨ï¼Ÿ[Y/n] " -n 1 -r
          echo
          if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
              WEBKIT_DISABLE_COMPOSITING_MODE=1 "$APP_DIR/${APP_NAME}" &
          fi
          INSTALLEOF

          chmod +x output/tauri-shell/install.sh

          # æ‰“åŒ…ä¸º tar.gz
          cd output
          tar -czvf tauri-shell.tar.gz tauri-shell

          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          echo "=== è¾“å‡ºæ–‡ä»¶ ==="
          ls -lh tauri-shell.tar.gz
          ls -lh tauri-shell/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tauri-template
          path: output/tauri-shell.tar.gz
          retention-days: 30
